\graphicspath{{chapters/03/media/}}
\chapter{Processamento dei dati}
\label{cha:processamento}
Dopo aver definito in \S\ref{cha:intro} l'obiettivo di questo progetto si deve definire una pipeline che, da dati di sequenziamento di RNA e da una lista di SNP esonici  sia in grado di fornire le istanze di espressione allelo-specifica.
Questa pipeline viene definita basandosi su quella presentata in \cite{ase_pipeline} e si compone pertanto di tre fasi principali:
\begin{enumerate}
	\item Pre-processamento e allineamento dei dati di RNA-seq, con eventuale deduplicazione e ricalibrazione.
	\item Analisi di dati \emph{WES} in modo da ottenere una lista di possibili SNP esonici da considerare.
	\item Calcolo dei dati di sbilanciamento allelico.
\end{enumerate}
La figura \ref{fig:proj_pipeline} \`e una visualizzazione della pipeline e dei tool utilizzati.\\
Essendo infine che questo lavoro prevede il processamento di un gran numero di file, unito al fatto che i tool utilizzzati sono stati implementati con una integrazione con le pipe di unix e con la possibilit\`a di essere eseguiti in multi-threading \`e stato di fondamentale importanza l'utility parallel \cite{parallel}.
In particolare nel caso di STAR\footnote{\S\ref{subsec:star}} \`e stato notato una diminuzione lineare delle performance per thread del tool.
L'abbassamento delle performance \`e stato risolto grazie a parallel, lanciando pi\`u istanze parallele del tool, ognuna di esse con pochi thread.
Si nota pertanto che parallel permette non solo un'elegante implementazione della pipeline, ma fornisce un livello di controllo tale da sfruttare completamente la potenza computazionale disponibile, riducendo in questo modo il tempo globale di esecuzione.


  \begin{figure}[H]
    \label{fig:proj_pipeline}
    \centering
    \includegraphics[scale=0.2]{pipeline.png}
    \caption{Pipeline per l'ottenimento dei dati di allelic imbalance}
  \end{figure}

  \section{Pre-processamento e allineamento dei dati RNA-seq}
  \label{sec:pre_all_rna_seq}
  Il primo passo della pipeline appenda definita \`e il pre-processamento e l'allineamento dei dati RNA-seq.
  L'input della pipeline sono dei file \emph{FASTQ}, ovvero file di testo che contengono i dati di sequenziamento raccolti in laboratorio tipicamente compressi.
  Questi file vengono modificati dai tool Trimmomatic, Star e Samtools in modo da produrre un output gi\`a utilizzabile per ottenere i dati di sbilanciamento allelico.
  Opzionalmente l'output pu\`o subire ulteriori modifiche prima di passare alla prossima fase: in particolare pu\`o essere deduplicato e ricalibrato.

  	\subsection{Trimmomatic}
	Trimmomatic \cite{trimmomatic} \`e il primo tool ad essere utilizzato.
	Il suo obiettivo \`e quello di eliminare dalle reads la sequenza adattatrice, o suoi frammenti, utilizzata per rendere possibile il sequenziamento.
	Essendo le RNA-seq fornite a single-ends\footnote{Punta a spiegazione nel capitolo 1} viene utilizzata la simple mode del tool.
	Questa scansiona ogni read\footnote{Non so se metterla in italiano} dalla terminazione $5'$ alla $3'$ per determinare la presenza della sequenza adattatrice.
	Utilizza il mdetodo ``seed and extend'' per trovare corrispondenze iniziali, anche non perfette, tra la read e la sequenza adattatrice.
	Successivamente svolge un allineamento locale e se questo ha uno score maggiore di una soglia viene rimosso insieme alla porzione successiva ad esso.
	Questa modalit\`a permette di identificare ogni sequenza adattatrice in ogni luogo della read a patto che l'allineamento sia abbastanza lungo e la read abbastanza accurata.
	Si nota per\`o come nelle regioni dove solo una corta corrispondenza parziale \`e possibile come alle estremit\`a della read e pertanto i contaminanti non possono essere identificati attendibilmente.
	Oltre alla rimozione delle sequenze adattatrici Trimmomatic tronca un'estremit\`a secondo un algoritmo di filtraggio secondo qualit\`a.
	Tra i metodi forniti dallo strumento \`e stato utilizzato quello del ``sliding window quality filtering'':
	scansiona la read dal $5'$ e rimuove la terminazione $3'$ quando la qualit\`a media di un gruppo di basi scende sotto una soglia specificata.
	Il risultato di questo passaggio sar\`a un altro fastq file con le sequenze adattatrici rimosse.

	\subsection{Star}
	\label{subsec:star}
	Star (spliced transcript alignment to a reference) \cite{star} \`e il secondo tool della pipeline.
	Prende come input il file fastq generato da Trimmomatic e un genoma di reference\footnote{Anche qui lo lascio in italiano?} e allineando il primo al secondo.
	Questo tool \`e stato creato con l'obiettivo di allineare RNA-seq di media-grande lunghezza, a differenza dei suoi competitori che, essendo creati a partire da allineatori per dati di DNA, hanno un maggiore tasso di errore.
	Questo avviene a causa degli eventi di splicing che avvengono nella creazione delle molecole di mRNA.
	Star pertanto si prefigge di permettere un allineamento accurato di reads che contengono mal-accoppiamenti, inserzioni o delezioni causati da variazioni genomiche o errori di sequenziamento mappando contemporaneamente sequenze derivate da regioni genomiche non contigue unite da eventi di splicing.
	Per farlo utilizza un algoritmo in due fasi.
	La prima fase o \emph{seed search} consiste della ricerca sequenziale di \emph{Maximal Mappable Prefix MMP}.
	Data una sequenza $R$, una regione $i$ e un genoma di reference $G$, $MMP(R, i, G)$ \`e la pi\`u lunga sottostringa $(R_i, R_{i+1}, \dots, R_{i+MMK-1})$ che corrisponde esattamente a una o pi\`u sottostringhe di $G$.
	$MML$ \`e la massima lunghezza mappabile.
	Questo permette un'identificazione di giunzioni di splicing senza nessuna conoscenza a priori.
	L'implementazione attraverso \emph{Uncompressed suffix arrays} causa alla complessit\`a dell'algoritmo di scalare logaritmicamente con la lunghezza del genoma di reference.
	Gli array sono non compressi per permettere tempi di ricerca pi\`u veloci, ma causano un aumento del consumo di memoria.
	La seconda fase o \emph{clustering, stitching and scoring} consiste nel costruire allineamenti dell'intera sequenza di reads unendo tutti i seed allineati al genoma nella prima fase.
	In primo luogo i seed sono raggruppati insieme secondo la vicinanza a un seed ancora selezionato limitando il numero di loci genomici a cui questo si allinea.
	Successivamente tutti i seed mappati nella \emph{genomic window} sono uniti insieme assumendo un modello lineare locale di trascrizione.
	Questo processo di unione viene inoltre guidato da un sistema di punteggi che penalizza mal-accoppiamenti, inserzioni, delezioni e \emph{splice junction gap}.
	Star ha come output un sam file, un file di testo delimitato da tabulazioni contenente una riga per allineamento con tutte le informazioni necessarie per la sua identificazione.

	\subsection{Samtools}
	I samtools \cite{samtools} sono un insieme di programmi necessari per interagire con i dati di sequenziamento.
	Nella pipeline sono utilizzati per compiere delle operazioni sui sam file generati da Star\footnote{Vedi \S\ref{subsec:star}} in modo da prepararli prima che possano essere utilizzati successivamente per generare i dati di sbilanciamento allelico\footnote{Vedi \S\ref{sec:aseq}}.
  In particolare svolgono le operazioni di ordinamento, indicizzazione e compressione dei file di input.
  Questo avviene attraverso due programmi: samtools sort \cite{samtools-sort} e samtools index \cite{samtools-index}.
  Il primo ordina gli allineamenti secondo le coordinate di inizio e comprime implicitamente l'input in formato bam.
  Il secondo invece crea, a partire dall'output del programma sort un indice in formato bai di tale file, permettendo efficienti operazioni di accesso casuale al bam file.
  L'output finale \`e un bam file ordinato e indicizzato che pu\`o essere utilizzato come input di aseq.

	\subsection{Deduplicazione e ricalibrazione}
	La deduplicazione e la ricalibrazione sono due processi ulteriori di pre-processamento dei dati che tentano di risolvere errori presenti nei bam file che sono stati allineati attraverso star\footnote{Vedi \S\ref{subsec:star}}.
  Questi due passaggi vengono svolti attraverso una serie di tools eseguiti sequenzialmente come si nota nella figura \ref{fig:pipeline_deduprecal}.
  \begin{figure}[H]
    \label{fig:pipeline_deduprecal}
    \centering
    \includegraphics[scale=0.17]{deduprecal.png}
    \caption{Pipeline di deduplicazione e ricalibrazione}
  \end{figure}
  Come si nota il primo passaggio viene svolto dal tool \emph{AddOrReplaceReadGroups} di Picard\cite{picard}, un passaggio di preparazione delle read necessario a tutti i tool successivi.
  Questo assegna tutte le reads in un file a un nuovo read-group settando un campo nel BAM file, in modo da assegnare tutte le reads a un genotipo specifico.


    \subsubsection{Deduplicazione}
    Si definiscono come read duplicate in un BAM file delle read che si generano da un singolo frammento di RNA.
    Possono originarsi durante la preparazione del campione, per esempio durante la costruzione della libreria attraverso PCR o risultare da un singolo cluster di amplificazione, identificato incorrettamente come cluster multipli dal sensore ottico dello strumento di sequenziamento.
    Il processo di deduplicazione \`e stato svolto attraverso il \emph{MarkDuplicates} di Picard.
    Il programma compara le sequenze nelle posizioni $5'$ sia delle reads che dei read-pairs.
    Dopo che ha trovato tutti le reads duplicata queste vengono ordinate secondo la somma dei punteggi di qualit\`a delle basi.
    La read con il punteggio pi\`u alto viene considerata primaria, le altre duplicati.
    Grazie all'opzione \emph{REMOVE\_DUPLICATE=true} tutte le sequenze duplicate vengono rimosse.
    Viene infine ricreato l'indice del BAM file attraverso \emph{samtools index}.

    \subsubsection{Ricalibrazione}
    La ricalibrazione viene svolta da una serie di tool facenti parte della suite Gatk \cite{gatk}.
    Il processo si compone di diverse fasi:
    \begin{multicols}{2}
      \begin{enumerate}
        \item Riallineamento degli indels.
        \item Ricalibrazione delle basi basata sul punteggio di qualtit\`a.
      \end{enumerate}
    \end{multicols}
    Il primo passaggio, svolto dal tool \emph{SplitNCigarReads}, progettato specificatamente per dati di RNA-seq \`e necessario per il corretto funzionamento degli step successivi.
    In un file BAM di RNA-seq infatti si trovano stringhe \emph{CIGAR} che descrivono come una base in ogni reads \`e mappata.
    Il valore $N$ corrisponde a una base saltata sul genoma di reference\footnote{Probabilmente in italiano}.
    Nel caso di RNA-seq tali basi possono corrispondere o a sequence introniche, non presenti nel RNA a causa dello splicing o a sequenze di ``overhang''\footnote{Magari una definizione di overhang}.
    \emph{SplitNCigarReads} elimina le basi corrispondenti a una $N$ creando dalla reads di partenza due reads, una a sinistra e una a destra della base rimossa.
    Come risultato gli esoni del RNA vengono separati in segmenti e gli overhang eliminati in modo da non causare falsi positivi.\\
    Dopo questo lavoro di processamento inizia la fase di riallineamento degli indels.
    Il riallineamento locale degli indels \`e necessario in quanto permette di correggere errori generati dall'allineatore genomico.
    Questi errori si generano in quanto gli allineatori genomici considerano ogni read indipendentemente e le strategie di assegnazione dei punteggi limitano la loro abilit\`a di allineare accuratamente nella presenza di indels.
    Il processo di allineamento locale considera invece tutte le letture che attraversano una posizione in modo da ottenere un consenso di alto punteggio che supporta la presenza di un evento di indel.
    Il riallineamento viene svolto attraverso l'utilizzo di due tool: \emph{RealignerTargetCreator} e \emph{IndelRealigner}.
    Il primo prende come input un BAM file ordinato e indicizzato.
    A partire dal file genera un file di output formato da una lista a una colonna contenente gli intervalli, che rappresentano siti di indel potenziali
    Se sono prossimali i siti sono uniti in un intervallo unico.
    Il secondo prende come input lo stesso BAM di \emph{RealignerTargetCreator} e il file di intervalli appena generato e svolge un riallineamento locale sulle reads coincidenti con l'intervallo target usando consensi dagli indel presenti nell'allineamento originale.
    L'output \`e un BAM ordinato e indicizzato.\\
    Il processo di ricalibrazione delle basi basato sul punteggio di qualit\`a serve a risolvere errori generati durante il sequenziamento.
    Si definisce il punteggio di qualit\`a di una base come una stime dell'errore emesso dalla macchina di sequenziamento: esprimono quanto questa \`e confidente che ha chiamato la base corretta ogni volta.
    Questi punteggi sono soggetti a varie sorgenti di errori tecnici dovuti alla fisica o alla chimica di come una reazione di sequenziamento funziona o a difetti nell'equipaggiamento.
    Gli errori portano pertanto a una sottostima o sovrastima (tipicamente la seconda) del punteggio di qualit\`a fornito dal macchinario di sequenziamento.
    Per tentare di risolvere si utilizza machine learning per modellarli empiricamente a modificare i valori di qualit\`a migliorarne la veridicit\`a.
    La ricalibrazione delle basi avviene attraverso l'utilizzo di due tool.
    Il primo \emph{BaseRecalibrator} costruisce un modello di covarianza da un BAM e da un insieme di varianti conosciute in un file VCF e lo salva in un file.
    Le varianti conosciute sono usate per mascherare basi ai siti di variazioni aspettate in modo da non considerarle come errori.
    Al di fuori di queste eccezioni ogni mal-accoppiamento viene contato come un errore.
    Per costruire il modello di ricalibrazione il tool tabula i dati del BAM secondo il read group, il punteggio di qualit\`a, il ciclo della macchina che ha prodotto la base, la base corrente e successiva.
    Successivamente si conta il numero di basi e quanto spesso queste hanno un mal-accoppiamento con la base di reference.
    Il secondo tool \emph{PrintReads} applica il modello creato dal primo al BAM di input, aggiornando cos\`i ai punteggi di qualit\`a migliorati.
    Infine viene ricreato l'indice del BAM file attraverso \emph{samtools index}.\\
    In questo modo si \`e creato un file BAN pronto per essere utilizzato da ASEQ.

  \section{Ottenimento degli SNP di interesse}
  Una volta ottenuti i file di allineamento si rende necessario ottenere una lista di SNP dei quali si vuole ottenere il valore di sbilanciamento allelico.
  Per ottenere questi dati sono stati utilizzati un file GTF ottenuto da\footnote{Mettere da dove si \`e ottenuto} contenente informazioni sulla porzione esonica del genoma umano e da un insieme di VCF divisi per cromosoma contenenti le informazioni riguardo le varianti ottenute negli essere umani.
  Dopo aver ristretto i VCF agli SNP sono stati intersecati con il file GTF.
  L'intersezione \`e stata volta dal tool \emph{bedtools intersect}, facente parte della suite bedtools\footnote{Inserisci sito}.
  Questo tool ha permesso di trovare ogni record del VCF presente anche nel GTF.
  In questo modo \`e stato creato un insieme di file VCF, uno per ogni cromosoma, contenente ogni SNP presente nella parte esonica del genoma.
  La restrizione alla parte esonica del genoma non causa alcuna perdita di potere predittivo in quanto si stanno considerando dati di RNA-seq e permette una significativa diminuzione del carico computazionale svolto da aseq\emph{riferimento ad aseq}.
  I VCF risultanti da questo processo sono pronti per essere utilizzati come input di aseq\footnote{riferimento ad aseq}.

  \section{Calcolo dei dati di sbilanciamento allelico}
  \label{sec:aseq}
